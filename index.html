<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Anime Dashboard</title>
    <style>
        :root {
            --bg-gradient: linear-gradient(to right, #24243e, #302b63, #0f0c29);
            --card-bg: rgba(255, 255, 255, 0.05);
            --text-main: #e0e0e0;
            --accent: #6e8efb;
            --gold: #ffcc33;
        }

        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: var(--bg-gradient); 
            color: var(--text-main);
            min-height: 100vh;
            margin: 0; padding: 20px;
        }

        .dashboard {
            background: rgba(110, 142, 251, 0.15);
            border: 1px solid var(--accent);
            border-radius: 20px;
            padding: 15px 30px;
            display: flex; justify-content: space-between; align-items: center;
            backdrop-filter: blur(15px);
            max-width: 1540px; margin: 0 auto 30px auto;
            position: sticky; top: 10px; z-index: 1000;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }

        .dash-left { display: flex; gap: 10px; align-items: center; }

        #loadingProgress { display: none; flex-direction: column; align-items: center; gap: 5px; transition: opacity 0.5s; margin: 0 20px; }
        .progress-track { width: 120px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; }
        #progressBar { width: 0%; height: 100%; background: var(--accent); transition: 0.3s; box-shadow: 0 0 10px var(--accent); }

        .stats-group { display: flex; gap: 30px; visibility: hidden; }
        .stat-item { text-align: center; }
        .stat-value { display: block; font-size: 1.2rem; font-weight: bold; color: #fff; }
        .stat-label { font-size: 0.65rem; opacity: 0.7; text-transform: uppercase; }

        .dash-right { display: flex; align-items: center; gap: 12px; }
        .version-tag {
            font-family: 'Courier New', monospace; font-size: 0.75rem; font-weight: bold;
            color: var(--accent); background: rgba(110, 142, 251, 0.1);
            padding: 6px 10px; border-radius: 10px; border: 1px solid rgba(110, 142, 251, 0.3);
            white-space: nowrap; opacity: 0.8;
        }

        #fileInput { display: none; }
        .btn-action {
            background: linear-gradient(45deg, #6e8efb, #a777e3);
            color: white; padding: 10px 20px; border-radius: 12px;
            cursor: pointer; font-size: 0.85rem; font-weight: bold; 
            transition: 0.3s; border: none; outline: none; display: flex; align-items: center;
        }
        .btn-action:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-random { background: linear-gradient(45deg, #f093fb, #f5576c); }
        .btn-archive { background: linear-gradient(45deg, #4facfe, #00f2fe); }
        .btn-clear { background: rgba(248, 113, 113, 0.2); border: 1px solid #f87171; color: #f87171; }

        #searchInput {
            background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 10px 15px; border-radius: 12px; color: white; width: 250px; outline: none;
        }

        .container { display: flex; gap: 25px; justify-content: center; flex-wrap: wrap; }
        .column { 
            background: var(--card-bg); border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 20px; width: 490px; padding: 25px; box-sizing: border-box;
        }

        h2 { text-align: center; font-size: 1.6rem; border-bottom: 2px solid rgba(255,255,255,0.1); padding-bottom: 20px; margin-top: 0; }
        .counter { opacity: 0.8; font-weight: 800; font-size: 1.8rem; font-family: 'Courier New', monospace; }
        
        .completed h2 { color: #4ade80; text-shadow: 0 0 15px rgba(74, 222, 128, 0.3); } 
        .planned h2 { color: #60a5fa; text-shadow: 0 0 15px rgba(96, 165, 250, 0.3); } 
        .dropped h2 { color: #f87171; text-shadow: 0 0 15px rgba(248, 113, 113, 0.3); }

        ul { list-style: none; padding: 0; margin: 0; }
        li { 
            padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); 
            display: flex; align-items: center; gap: 15px; transition: 0.3s;
            position: relative; z-index: 1;
        }
        li:hover { background: rgba(255,255,255,0.05); border-radius: 12px; z-index: 100; }
        li.hidden { display: none !important; }
        li.highlight-random { background: rgba(255, 204, 51, 0.2); border: 1px solid var(--gold); border-radius: 12px; z-index: 50; }

        .list-poster { 
            width: 60px; height: 85px; border-radius: 6px; object-fit: cover; 
            transition: transform 0.3s ease; background: rgba(255,255,255,0.05); 
            flex-shrink: 0; position: relative; z-index: 2; cursor: pointer;
        }
        .list-poster:hover:not([src*="yandex"]) { 
            transform: scale(3.5); z-index: 9999 !important; 
            border: 1px solid var(--accent); /* –¢–æ–Ω–∫–∞—è –æ–±–≤–æ–¥–∫–∞ 1px */
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }

        .main-info { flex-grow: 1; display: flex; flex-direction: column; gap: 5px; min-width: 0; }
        .anime-link { color: #fff; text-decoration: none; font-weight: 600; font-size: 0.95rem; line-height: 1.3; }
        .anime-link:hover { color: var(--accent); }
        .meta-row { display: flex; gap: 10px; font-size: 11px; color: #bbb; align-items: center; }
        .type-tag { background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; text-transform: uppercase; color: #e0e0e0; font-size: 10px; border: 1px solid rgba(255,255,255,0.1); }
        
        .score { 
            background: rgba(0, 0, 0, 0.4); padding: 6px 12px; border-radius: 10px; 
            font-size: 12px; color: var(--gold); font-weight: bold; 
            border: 1px solid rgba(255, 204, 51, 0.1); white-space: nowrap; 
            margin-left: auto; /* –ü—Ä–∏–∂–∏–º–∞–µ—Ç –æ—Ü–µ–Ω–∫—É –≤–ø—Ä–∞–≤–æ */
        }

        #fullScreenGrid { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f0c29; z-index: 2000; overflow-y: auto; padding: 40px; box-sizing: border-box; }
        .grid-header { display: flex; justify-content: space-between; align-items: center; max-width: 1700px; margin: 0 auto 30px; }
        .grid-layout { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; max-width: 1700px; margin: 0 auto; }
        .grid-card { background: rgba(255, 255, 255, 0.05); border-radius: 12px; overflow: hidden; transition: 0.3s; border: 1px solid rgba(255,255,255,0.1); text-decoration: none; color: inherit; }
        .grid-card img { width: 100%; height: 270px; object-fit: cover; }
        .grid-card-info { padding: 12px; }
    </style>
</head>
<body>

    <div class="dashboard">
        <div class="dash-left">
            <label id="fileLabel" for="fileInput" class="btn-action">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å JSON</label>
            <input type="file" id="fileInput" accept=".json">
            <button id="viewGridBtn" class="btn-action btn-archive" style="display: none;">üñº –ê—Ä—Ö–∏–≤</button>
            <button id="randomBtn" class="btn-action btn-random" style="display: none;">üé≤ –†–∞–Ω–¥–æ–º</button>
            <button id="clearBtn" class="btn-action btn-clear" style="display: none;">üóë –°–±—Ä–æ—Å</button>
        </div>

        <div id="loadingProgress">
            <div style="font-size: 10px; color: var(--accent); font-weight: bold;">
                –ü–û–°–¢–ï–†–´: <span id="imgCurrent">0</span> / <span id="imgTotal">0</span>
            </div>
            <div class="progress-track"><div id="progressBar"></div></div>
        </div>

        <div class="stats-group" id="statsDisplay">
            <div class="stat-item"><span class="stat-value" id="totalEpisodes">0</span><span class="stat-label">–≠–ø–∏–∑–æ–¥–æ–≤</span></div>
            <div class="stat-item"><span class="stat-value" id="totalTime">0</span><span class="stat-label">–í—Ä–µ–º–µ–Ω–∏ –∂–∏–∑–Ω–∏ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ</span></div>
            <div class="stat-item"><span class="stat-value" id="avgScore">0</span><span class="stat-label">–ë–∞–ª–ª</span></div>
        </div>

        <div class="dash-right">
            <span class="version-tag">---</span>
            <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –∞–Ω–∏–º–µ...">
        </div>
    </div>

    <div class="container">
        <div class="column completed"><h2>–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ <span id="count-completed" class="counter">0</span></h2><ul id="completedList"></ul></div>
        <div class="column planned"><h2>–í –ø–ª–∞–Ω–∞—Ö <span id="count-planned" class="counter">0</span></h2><ul id="plannedList"></ul></div>
        <div class="column dropped"><h2>–ë—Ä–æ—à–µ–Ω–æ <span id="count-dropped" class="counter">0</span></h2><ul id="droppedList"></ul></div>
    </div>

    <div id="fullScreenGrid">
        <div class="grid-header">
            <h1 style="margin: 0; color: #4ade80;">–ê—Ä—Ö–∏–≤ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω–æ–≥–æ</h1>
            <button id="closeGrid" class="btn-action" style="background: #f87171;">–ó–∞–∫—Ä—ã—Ç—å ‚úï</button>
        </div>
        <div id="gridContainer" class="grid-layout"></div>
    </div>

    <script>
        // --- 1. –¶–ï–ù–¢–†–ê–õ–¨–ù–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
        const CONFIG = {
            version: "v1.2.8",
            fallbackImg: "https://avatars.mds.yandex.net/i?id=101965c7ffae37ffb927194c3f08c42b4d5515d7-8218669-images-thumbs&n=13",
            shiki: {
                img: (id) => `https://shiki.one/system/animes/original/${id}.jpg`,
                url: (id) => `https://shiki.one/animes/${id}`
            },
            dbName: "AnimePosterCache",
            storageKey: 'animeDashData'
        };

        let animeData = [];
        let currentLoadSession = 0; 
        let db;

        const request = indexedDB.open(CONFIG.dbName, 1);
        request.onupgradeneeded = (e) => e.target.result.createObjectStore("posters");
        request.onsuccess = (e) => { 
            db = e.target.result; 
            document.querySelector('.version-tag').textContent = CONFIG.version;
            initApp(); 
        };

        function initApp() {
            const saved = localStorage.getItem(CONFIG.storageKey);
            if (saved) {
                animeData = JSON.parse(saved);
                renderUI(animeData);
                updateVisibility(true);
            } else { updateVisibility(false); }
        }

        async function getCachedPoster(id, imgElement, totalCount, session) {
            const url = CONFIG.shiki.img(id);
            const handleFinish = () => updateImgProgress(totalCount, session);

            imgElement.onload = handleFinish;
            imgElement.onerror = () => {
                if (imgElement.src !== CONFIG.fallbackImg) {
                    imgElement.src = CONFIG.fallbackImg;
                } else {
                    handleFinish();
                }
            };

            if (!db) { imgElement.src = url; return; }

            const tx = db.transaction("posters", "readonly");
            const store = tx.objectStore("posters");
            const getReq = store.get(id);

            getReq.onsuccess = async () => {
                if (getReq.result) { 
                    imgElement.src = URL.createObjectURL(getReq.result);
                } else {
                    try {
                        const resp = await fetch(url);
                        if (!resp.ok) throw new Error();
                        const blob = await resp.blob();
                        const saveTx = db.transaction("posters", "readwrite");
                        saveTx.objectStore("posters").put(blob, id);
                        imgElement.src = URL.createObjectURL(blob);
                    } catch (e) {
                        imgElement.src = url;
                    }
                }
            };
        }

        function updateImgProgress(total, session) {
            if (session !== currentLoadSession) return;
            const curText = document.getElementById('imgCurrent');
            const newCount = parseInt(curText.textContent) + 1;
            const percent = Math.min(100, Math.round((newCount / total) * 100));
            const bar = document.getElementById('progressBar');
            const container = document.getElementById('loadingProgress');
            
            curText.textContent = newCount;
            if(bar) bar.style.width = percent + "%";
            
            if (newCount >= total) {
                setTimeout(() => { 
                    if(container && session === currentLoadSession) container.style.opacity = "0"; 
                    setTimeout(() => { if(container && session === currentLoadSession) container.style.display = 'none'; }, 600);
                }, 2500); 
            }
        }

        function renderUI(data) {
            const lists = { completed: document.getElementById('completedList'), planned: document.getElementById('plannedList'), dropped: document.getElementById('droppedList') };
            Object.values(lists).forEach(l => l.innerHTML = '');
            
            currentLoadSession++;
            const sessionNow = currentLoadSession;
            document.getElementById('imgCurrent').textContent = "0";
            document.getElementById('imgTotal').textContent = data.length;
            document.getElementById('progressBar').style.width = "0%";
            document.getElementById('loadingProgress').style.display = 'flex';
            document.getElementById('loadingProgress').style.opacity = '1';

            let epTotal = 0, sumScore = 0, countScore = 0;
            let counts = { completed: 0, planned: 0, dropped: 0 };
            data.sort((a, b) => (a.target_title_ru || a.target_title || "").localeCompare(b.target_title_ru || b.target_title || ""));

            data.forEach(item => {
                const ul = lists[item.status];
                if (!ul) return;
                counts[item.status]++;
                if (item.status === 'completed') {
                    epTotal += (item.episodes * (1 + (item.rewatches || 0)));
                    if (item.score > 0) { sumScore += item.score; countScore++; }
                }

                const li = document.createElement('li');
                li.innerHTML = `
                    <img class="list-poster" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
                    <div class="main-info">
                        <a href="${CONFIG.shiki.url(item.target_id)}" target="_blank" class="anime-link">${item.target_title_ru || item.target_title}</a>
                        <div class="meta-row"><span class="type-tag">${item.target_type}</span><span>${item.episodes} —ç–ø.</span></div>
                    </div>
                    ${item.score > 0 ? `<div class="score">‚≠ê ${item.score} / 10</div>` : ''}`;
                ul.appendChild(li);
                getCachedPoster(item.target_id, li.querySelector('.list-poster'), data.length, sessionNow);
            });

            document.getElementById('totalEpisodes').textContent = epTotal;
            const h = Math.floor((epTotal * 24) / 60);
            document.getElementById('totalTime').textContent = `${Math.floor(h/24)}–¥. ${h%24}—á.`;
            document.getElementById('avgScore').textContent = countScore ? (sumScore/countScore).toFixed(2) : "0";
            Object.keys(counts).forEach(id => { document.getElementById(`count-${id}`).textContent = counts[id]; });
        }

        function renderGrid() {
            const grid = document.getElementById('gridContainer');
            grid.innerHTML = '';
            const completed = animeData.filter(i => i.status === 'completed');
            currentLoadSession++;
            const sessionNow = currentLoadSession;
            document.getElementById('imgCurrent').textContent = "0";
            document.getElementById('imgTotal').textContent = completed.length;
            document.getElementById('progressBar').style.width = "0%";
            document.getElementById('loadingProgress').style.display = 'flex';
            document.getElementById('loadingProgress').style.opacity = '1';

            completed.forEach(item => {
                const card = document.createElement('a');
                card.className = 'grid-card';
                card.href = CONFIG.shiki.url(item.target_id);
                card.target = "_blank";
                card.innerHTML = `
                    <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
                    <div class="grid-card-info">
                        <div style="font-weight:bold; color:#fff; font-size:0.85rem;">${item.target_title_ru || item.target_title}</div>
                        <div style="display:flex; justify-content:space-between; margin-top:5px;">
                            <span class="type-tag" style="font-size:9px;">${item.target_type}</span>
                            ${item.score > 0 ? `<span style="color:var(--gold); font-weight:bold;">‚≠ê ${item.score}</span>` : ''}
                        </div>
                    </div>`;
                grid.appendChild(card);
                getCachedPoster(item.target_id, card.querySelector('img'), completed.length, sessionNow);
            });
        }

        document.getElementById('fileInput').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                animeData = JSON.parse(ev.target.result);
                localStorage.setItem(CONFIG.storageKey, JSON.stringify(animeData));
                renderUI(animeData);
                updateVisibility(true);
            };
            reader.readAsText(e.target.files[0]);
        };

        document.getElementById('viewGridBtn').onclick = () => { renderGrid(); document.getElementById('fullScreenGrid').style.display = 'block'; document.body.style.overflow = 'hidden'; };
        document.getElementById('closeGrid').onclick = () => { document.getElementById('fullScreenGrid').style.display = 'none'; document.body.style.overflow = 'auto'; };
        document.getElementById('searchInput').oninput = (e) => {
            const term = e.target.value.toLowerCase();
            document.querySelectorAll('ul li').forEach(li => li.classList.toggle('hidden', !li.querySelector('.anime-link').textContent.toLowerCase().includes(term)));
        };
        document.getElementById('clearBtn').onclick = () => { if(confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë?")) { localStorage.clear(); indexedDB.deleteDatabase(CONFIG.dbName); location.reload(); } };
        document.getElementById('randomBtn').onclick = () => {
            const items = Array.from(document.querySelectorAll('#plannedList li:not(.hidden)'));
            if (!items.length) return;
            document.querySelectorAll('li.highlight-random').forEach(el => el.classList.remove('highlight-random'));
            const target = items[Math.floor(Math.random() * items.length)];
            target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            target.classList.add('highlight-random');
        };

        function updateVisibility(hasData) {
            document.getElementById('statsDisplay').style.visibility = hasData ? 'visible' : 'hidden';
            ['randomBtn', 'clearBtn', 'viewGridBtn'].forEach(id => document.getElementById(id).style.display = hasData ? 'flex' : 'none');
            document.getElementById('fileLabel').style.display = hasData ? 'none' : 'flex';
        }
    </script>
</body>
</html>
